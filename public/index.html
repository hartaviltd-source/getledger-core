<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>GetLedger Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; z-index: 50; }
        .fab { position: fixed; bottom: 5rem; right: 1rem; width: 3.5rem; height: 3.5rem; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(79,70,229,0.4); z-index: 40; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">
<div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-600 to-purple-700">
    <div class="w-full max-w-sm px-6">
        <div class="text-center mb-8">
            <div class="w-20 h-20 mx-auto mb-4 bg-white/20 rounded-2xl flex items-center justify-center">
                <i class="fas fa-calculator text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white">GetLedger</h1>
            <p class="text-indigo-200">VPS Muhasebe Sistemi</p>
        </div>
        <form id="loginForm" class="space-y-4">
            <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-white/10 border-0 rounded-xl text-white placeholder-indigo-200" placeholder="E-posta" value="admin@getledgercore.pro">
            <input type="password" id="loginPassword" class="w-full px-4 py-3 bg-white/10 border-0 rounded-xl text-white placeholder-indigo-200" placeholder="Şifre" value="admin123">
            <button type="submit" id="loginBtn" class="w-full py-3 bg-white text-indigo-600 font-bold rounded-xl">
                <span id="loginText">Giriş Yap</span>
            </button>
        </form>
        <p id="loginError" class="mt-4 text-red-300 text-center text-sm hidden"></p>
    </div>
</div>

<div id="app" class="hidden min-h-screen pb-20">
    <header class="bg-white sticky top-0 z-30 border-b">
        <div class="flex items-center justify-between px-4 py-3">
            <h1 id="pageTitle" class="text-lg font-bold">Ana Sayfa</h1>
            <button onclick="logout()" class="text-gray-600"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="p-4 space-y-4">
        <div id="dashboardSection" class="section active">
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                    <p class="text-indigo-200 text-xs">Bakiye</p>
                    <p class="text-2xl font-bold" id="balance">₺0,00</p>
                </div>
                <div class="card p-4">
                    <p class="text-gray-500 text-xs">Bekleyen</p>
                    <p class="text-2xl font-bold text-gray-900" id="pendingCount">0</p>
                </div>
            </div>
            <div class="card p-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">Gelir</span>
                    <span class="font-bold text-green-600" id="totalIncome">₺0,00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Gider</span>
                    <span class="font-bold text-red-600" id="totalExpense">₺0,00</span>
                </div>
            </div>
            <div class="card p-4">
                <h3 class="font-bold mb-3">Son Faturalar</h3>
                <div id="recentInvoices" class="space-y-2"></div>
            </div>
        </div>

        <div id="invoicesSection" class="section">
            <div class="flex space-x-2 overflow-x-auto pb-2">
                <button onclick="filterInv('all')" class="filter-btn px-4 py-2 rounded-full text-sm bg-indigo-600 text-white" data-filter="all">Tümü</button>
                <button onclick="filterInv('pending')" class="filter-btn px-4 py-2 rounded-full text-sm bg-white" data-filter="pending">Bekleyen</button>
                <button onclick="filterInv('paid')" class="filter-btn px-4 py-2 rounded-full text-sm bg-white" data-filter="paid">Ödenen</button>
            </div>
            <div id="invoicesList" class="space-y-3"></div>
        </div>

        <div id="toolsSection" class="section space-y-3">
            <div class="card p-4 text-center cursor-pointer" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-file-import text-3xl text-green-600 mb-2"></i>
                <p class="font-bold">Excel İçe Aktar</p>
                <input type="file" id="importFile" class="hidden" accept=".xlsx,.csv" onchange="importData(this)">
            </div>
            <button onclick="exportData('invoices')" class="w-full card p-4 text-left flex items-center justify-between">
                <span><i class="fas fa-file-excel text-green-600 mr-2"></i> Faturaları İndir</span>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
            <button onclick="exportData('all')" class="w-full card p-4 text-left flex items-center justify-between">
                <span><i class="fas fa-database text-purple-600 mr-2"></i> Tam Yedekleme</span>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
        </div>
    </main>

    <nav class="bottom-nav safe-bottom">
        <div class="flex justify-around py-2">
            <button onclick="showSection('dashboard')" class="nav-btn p-2 text-indigo-600" data-sec="dashboard"><i class="fas fa-home text-xl"></i><p class="text-xs">Ana Sayfa</p></button>
            <button onclick="showSection('invoices')" class="nav-btn p-2 text-gray-400" data-sec="invoices"><i class="fas fa-file-invoice text-xl"></i><p class="text-xs">Faturalar</p></button>
            <div class="w-12"></div>
            <button onclick="showSection('tools')" class="nav-btn p-2 text-gray-400" data-sec="tools"><i class="fas fa-tools text-xl"></i><p class="text-xs">Araçlar</p></button>
        </div>
    </nav>

    <button onclick="showInvoiceModal()" class="fab"><i class="fas fa-plus text-xl"></i></button>
</div>

<div id="invoiceModal" class="fixed inset-0 z-50 hidden bg-black/50" onclick="if(event.target===this)closeInvoiceModal()">
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl p-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Yeni Fatura</h3>
            <button onclick="closeInvoiceModal()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setInvType('sales')" id="btnSales" class="py-2 rounded-lg bg-indigo-600 text-white text-sm">Satış</button>
                <button onclick="setInvType('purchase')" id="btnPurchase" class="py-2 rounded-lg bg-gray-200 text-sm">Alış</button>
            </div>
            <input type="text" id="invNumber" placeholder="Fatura No" class="w-full px-3 py-2 border rounded-lg">
            <input type="text" id="invContact" placeholder="Müşteri/Tedarikçi" class="w-full px-3 py-2 border rounded-lg">
            <input type="date" id="invDate" class="w-full px-3 py-2 border rounded-lg">
            <div id="invItems" class="space-y-2">
                <div class="flex gap-2">
                    <input type="text" placeholder="Açıklama" class="flex-1 px-3 py-2 border rounded-lg text-sm item-desc">
                    <input type="number" placeholder="Tutar" class="w-24 px-3 py-2 border rounded-lg text-sm item-price" onchange="calcTotal()">
                </div>
            </div>
            <button onclick="addItem()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-sm text-gray-500">+ Kalem Ekle</button>
            <div class="flex justify-between items-center pt-3 border-t">
                <span class="font-bold">Toplam</span>
                <span class="text-xl font-bold text-indigo-600" id="invTotal">₺0,00</span>
            </div>
            <button onclick="saveInvoice()" class="w-full py-3 btn-primary rounded-lg font-bold">Kaydet</button>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity pointer-events-none z-50"></div>

<script>
const API_URL = '';
let token = localStorage.getItem('token');
let currentInvType = 'sales';

if (token) verifyToken();

document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const text = document.getElementById('loginText');
    const error = document.getElementById('loginError');
    
    btn.disabled = true;
    text.innerHTML = '<span class="loading"></span>';
    error.classList.add('hidden');
    
    try {
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            })
        });
        
        const data = await res.json();
        if (data.token) {
            token = data.token;
            localStorage.setItem('token', token);
            showApp();
        } else {
            throw new Error(data.error || 'Login failed');
        }
    } catch (err) {
        error.textContent = err.message;
        error.classList.remove('hidden');
        btn.disabled = false;
        text.textContent = 'Giriş Yap';
    }
};

async function verifyToken() {
    try {
        const res = await fetch('/api/stats', { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.ok) showApp();
        else logout();
    } catch {
        logout();
    }
}

function showApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadDashboard();
}

function logout() {
    localStorage.removeItem('token');
    token = null;
    location.reload();
}

async function api(endpoint, options = {}) {
    const res = await fetch('/api' + endpoint, {
        ...options,
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            ...options.headers
        }
    });
    if (res.status === 401) { logout(); return; }
    return res.json();
}

function showSection(sec) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sec + 'Section').classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => {
        b.className = 'nav-btn p-2 ' + (b.dataset.sec === sec ? 'text-indigo-600' : 'text-gray-400');
    });
    document.getElementById('pageTitle').textContent = 
        sec === 'dashboard' ? 'Ana Sayfa' : sec === 'invoices' ? 'Faturalar' : 'Araçlar';
    if (sec === 'invoices') loadInvoices();
}

async function loadDashboard() {
    const stats = await api('/stats');
    document.getElementById('balance').textContent = formatMoney(stats.balance);
    document.getElementById('totalIncome').textContent = formatMoney(stats.income);
    document.getElementById('totalExpense').textContent = formatMoney(stats.expense);
    document.getElementById('pendingCount').textContent = stats.pending_count;
    
    const invoices = await api('/invoices?limit=5');
    document.getElementById('recentInvoices').innerHTML = invoices.slice(0,5).map(inv => `
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
            <div>
                <p class="font-medium text-sm">${inv.contact_name}</p>
                <p class="text-xs text-gray-500">${inv.invoice_number}</p>
            </div>
            <div class="text-right">
                <p class="font-bold text-sm">${formatMoney(inv.total)}</p>
                <span class="text-xs px-2 py-0.5 rounded-full ${inv.status==='paid'?'bg-green-100 text-green-700':inv.status==='pending'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}">${inv.status}</span>
            </div>
        </div>
    `).join('');
}

async function loadInvoices() {
    const filter = document.querySelector('.filter-btn.bg-indigo-600')?.dataset.filter || 'all';
    const url = filter === 'all' ? '/invoices' : `/invoices?status=${filter}`;
    const invoices = await api(url);
    
    document.getElementById('invoicesList').innerHTML = invoices.map(inv => `
        <div class="card p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="font-bold">${inv.invoice_number}</p>
                    <p class="text-sm text-gray-500">${inv.contact_name}</p>
                </div>
                <span class="text-xs px-2 py-1 rounded-full ${inv.status==='paid'?'bg-green-100 text-green-700':inv.status==='pending'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}">${inv.status}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-400">${inv.date}</span>
                <span class="text-lg font-bold ${inv.type==='sales'?'text-indigo-600':'text-red-600'}">${formatMoney(inv.total)}</span>
            </div>
            <button onclick="deleteInvoice(${inv.id})" class="mt-2 text-red-500 text-sm"><i class="fas fa-trash"></i> Sil</button>
        </div>
    `).join('');
}

function filterInv(f) {
    document.querySelectorAll('.filter-btn').forEach(b => {
        b.className = 'filter-btn px-4 py-2 rounded-full text-sm ' + (b.dataset.filter === f ? 'bg-indigo-600 text-white' : 'bg-white');
    });
    loadInvoices();
}

async function deleteInvoice(id) {
    if (!confirm('Silinsin mi?')) return;
    await api(`/invoices/${id}`, { method: 'DELETE' });
    showToast('Fatura silindi');
    loadInvoices();
    loadDashboard();
}

function showInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('hidden');
    document.getElementById('invDate').valueAsDate = new Date();
    document.getElementById('invNumber').value = 'FTR-' + Date.now().toString().slice(-6);
    setInvType('sales');
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.add('hidden');
}

function setInvType(t) {
    currentInvType = t;
    document.getElementById('btnSales').className = t==='sales'?'py-2 rounded-lg bg-indigo-600 text-white text-sm':'py-2 rounded-lg bg-gray-200 text-sm';
    document.getElementById('btnPurchase').className = t==='purchase'?'py-2 rounded-lg bg-indigo-600 text-white text-sm':'py-2 rounded-lg bg-gray-200 text-sm';
}

function addItem() {
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = '<input type="text" placeholder="Açıklama" class="flex-1 px-3 py-2 border rounded-lg text-sm item-desc"><input type="number" placeholder="Tutar" class="w-24 px-3 py-2 border rounded-lg text-sm item-price" onchange="calcTotal()">';
    document.getElementById('invItems').appendChild(div);
}

function calcTotal() {
    let total = 0;
    document.querySelectorAll('.item-price').forEach(i => total += parseFloat(i.value) || 0);
    document.getElementById('invTotal').textContent = formatMoney(total);
}

async function saveInvoice() {
    const items = [];
    document.querySelectorAll('#invItems > div').forEach((div, idx) => {
        items.push({
            desc: div.querySelector('.item-desc').value || 'Kalem ' + (idx+1),
            qty: 1,
            price: parseFloat(div.querySelector('.item-price').value) || 0
        });
    });
    
    const total = items.reduce((s, i) => s + i.price, 0);
    
    await api('/invoices', {
        method: 'POST',
        body: JSON.stringify({
            invoice_number: document.getElementById('invNumber').value,
            type: currentInvType,
            contact_name: document.getElementById('invContact').value,
            date: document.getElementById('invDate').value,
            due_date: document.getElementById('invDate').value,
            total: total,
            status: 'pending',
            items: items,
            notes: ''
        })
    });
    
    closeInvoiceModal();
    showToast('Fatura kaydedildi');
    loadDashboard();
    if (!document.getElementById('invoicesSection').classList.contains('active')) {
        showSection('invoices');
    } else {
        loadInvoices();
    }
}

async function importData(input) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    showToast('Aktarılıyor...');
    
    const res = await fetch('/api/import', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
    });
    
    const data = await res.json();
    showToast(`${data.imported} kayıt aktarıldı`);
    loadDashboard();
}

async function exportData(type) {
    showToast('İndiriliyor...');
    window.location.href = `/api/export?type=${type}&token=${token}`;
}

function formatMoney(n) {
    return '₺' + parseFloat(n).toLocaleString('tr-TR', {minimumFractionDigits: 2});
}

function showToast(m) {
    const t = document.getElementById('toast');
    t.textContent = m;
    t.classList.remove('opacity-0');
    setTimeout(() => t.classList.add('opacity-0'), 2000);
}
</script>
</body>
</html>
